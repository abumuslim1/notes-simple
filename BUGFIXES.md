# Исправления ошибок Notes Service

## Проблема с авторизацией (Исправлено)

### Описание проблемы
После успешного входа пользователь перенаправлялся обратно на форму входа вместо получения доступа к защищенным маршрутам.

### Причина
Флаг `secure: true` в функции `setAuthCookie()` в файле `server/_core/sdk.ts` блокировал сохранение куки при использовании HTTP (локальное развертывание).

Браузер не сохраняет куки с флагом `secure: true` на HTTP соединениях - это требование безопасности. Флаг `secure` указывает браузеру отправлять куки только через HTTPS.

### Решение
Флаг `secure` теперь автоматически устанавливается в зависимости от переменной окружения `NODE_ENV`:

```typescript
// server/_core/sdk.ts
setAuthCookie(res: any, token: string) {
  res.cookie(COOKIE_NAME, token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production", // true для production, false для development
    sameSite: "lax",
    maxAge: 30 * 24 * 60 * 60 * 1000,
    path: "/",
  });
}
```

**Результат:**
- **Development (HTTP)**: `secure: false` - куки сохраняются на HTTP
- **Production (HTTPS)**: `secure: true` - куки сохраняются только на HTTPS

### Файлы, которые были изменены
1. `server/_core/sdk.ts` - добавлены комментарии о флаге secure
2. `install.sh` - добавлены замечания о проблеме с куками и исправлениях
3. `DEPLOYMENT.md` - добавлена секция "Важные замечания о безопасности" с описанием проблемы и решения

### Как протестировать
1. Откройте приложение на `http://localhost:3000`
2. Введите учетные данные (логин: admin, пароль: admin)
3. Нажмите кнопку входа
4. Вы должны быть перенаправлены на главную страницу (не на форму входа)
5. Проверьте DevTools → Application → Cookies - должна быть кука `auth_token`

## Другие исправления

### SQL ошибка в таблице taskStatusHistory
Таблица `taskStatusHistory` была создана с правильной структурой для логирования изменений статуса задач.

### Система авторизации с JWT
- Реализована генерация JWT токенов с помощью `jsonwebtoken`
- Добавлена верификация токенов при каждом запросе
- Реализована система ролей (admin/user)
- Первый зарегистрировавшийся пользователь автоматически получает роль администратора

## Рекомендации для production

1. **HTTPS обязателен**: Убедитесь, что приложение работает через HTTPS с валидным SSL сертификатом
2. **Переменная NODE_ENV**: Установите `NODE_ENV=production` в файле `.env` на production сервере
3. **JWT_SECRET**: Используйте надежный секретный ключ (минимум 32 символа)
4. **Регистрация**: По умолчанию публичная регистрация отключена - включите её в настройках лицензии если нужно

## Версия
- Дата исправления: 2025-12-09
- Версия приложения: 1.0.0
